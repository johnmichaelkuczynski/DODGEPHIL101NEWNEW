HERE IS THE LOGIN/PAYMENT SYSTEM WORKFLOW
WHEN AN UNREGISTERED GETS A PREVIEW RESPONSE, THERE IS A LINK FOR HIM TO REGISTER EMBEDDED IN THE POPUP THAT CONTAINS THE PREVIEW PARTIAL RESPONSE. 
AFTER HE REGISTERS, HE AUTOMATICALLY LOGS IN. 
ONCE HE IS IN, HE BUYS CREDITS BY HITTING THE ‘BUY CREDITS’ BUTTON. THIS TAKES HIM TO A SCREEN WHERE HAS THE EXISTING OPTIONS. BUT WHEN HE CLICKS A GIVEN OPTION, IT BECOMES HIGHLIGHTED. MOREOVER, THERE IS NO $10 MOST POPULAR PRE-HIGHLIGHTED ONE.  
AFTER USERS PURCHASES CREDITS, HE IS AUTOMATICALLY TAKEN BACK (LOGGED IN) TO HIS PAGE, WHERE (AT THE TOP IT SHOWS HOW MANY CREDITS HE HAS. 
WHEN A REGISTERED USER WITH INSUFFICIENT CREDITS GETS A PREVIEW RESPONSE, THERE IS A LINK TO THE PAYMENT OPTIONS. . THIS TAKES HIM TO A SCREEN WHERE HAS THE EXISTING OPTIONS. BUT WHEN HE CLICKS A GIVEN OPTION, IT BECOMES HIGHLIGHTED. MOREOVER, THERE IS NO $10 MOST POPULAR PRE-HIGHLIGHTED ONE.  
WHEN THE USER SUCCESSFULLYK PURCHASES CREDITS, HE IS TAKEN BACK (LOGGED IN) TO THE SITE, WHERE IT DISPLAYS HIS NEW NUMBER OF CREDITS AT THE TOP. 
TO REGISTER THE USER ONLY HAS TO PROVIDE A USERNAME AND PASSWORD; HE DOS NOT HAVE TO PROVIDE AN EMAIL. IF HE DOES PROVIDE AN EMAIL, IT IS NOT VERIFIED. 
PAYMENTS ARE DONE THROUGH STRIPE USING THE FOLLOWING SECRETS: 
STRIPE_WEBHOOK_SECRET_1PHILOSOPHYDICTIONARY
STRIPE_SECRET_KEY
STRIPE_PUBLISHABLE_KEY
When creating the Stripe checkout session, you must pass the logged-in user’s ID or username as metadata. Example:

css
Copy
Edit
metadata: {
  user_id: current_user_id
}
After the payment succeeds, Stripe will hit your webhook. Your webhook must:

Extract the user_id from event['data']['object']['metadata']

Add the correct number of credits to that user in the database

Webhook route must be enabled at

bash
Copy
Edit
/webhook
and registered in Stripe with this secret:

nginx
Copy
Edit
STRIPE_WEBHOOK_SECRET_1PHILOSOPHYDICTIONARY
After payment, the user is redirected to

bash
Copy
Edit
/success
which should:

Automatically log them in (if needed)

Display their updated credit balance